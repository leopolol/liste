<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listes partag√©es</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- App shell -->
  <div class="max-w-3xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Listes partag√©es</h1>
          <p class="text-slate-600 mt-1 text-sm">
            Cr√©e une liste, partage le lien, attribuez les items en 2 clics.
          </p>
        </div>

        <div class="flex gap-2">
          <button id="btnShareTop" class="hidden rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50">
            Partager
          </button>
          <button id="btnAdminTop" class="hidden rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50">
            Mode √©dition
          </button>
        </div>
      </div>
    </header>

    <!-- Create panel -->
    <section id="createPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
      <h2 class="text-lg font-semibold">Cr√©er une nouvelle liste</h2>
      <p class="text-sm text-slate-600 mt-1">
        Choisis un template : les champs, statuts et suggestions s‚Äôadaptent automatiquement.
      </p>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-medium text-slate-700">Titre</label>
          <input id="inpListTitle" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Ex: No√´l 2025 / Roadtrip Espagne / Repas chez Paul" />
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Type de liste</label>
          <select id="selListType" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
            <option value="cadeaux">üéÅ Cadeaux</option>
            <option value="courses">üõí Courses / Achats</option>
            <option value="voyage">üß≥ Voyage (checklist)</option>
            <option value="roadtrip">üöó Roadtrip</option>
            <option value="repas">üçΩÔ∏è Repas ‚Äúqui ram√®ne quoi‚Äù</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Code admin (obligatoire)</label>
          <input id="inpAdminCode" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Garde-le, il active l‚Äô√©dition" />
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Code d‚Äôacc√®s (optionnel)</label>
          <input id="inpAccessCode" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Si tu veux prot√©ger la consultation" />
        </div>
      </div>

      <div class="mt-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="text-xs text-slate-500">
          Le lien partag√© contient l‚ÄôID de la liste. Les codes sont stock√©s <span class="font-semibold">hach√©s</span> (SHA-256).
        </div>
        <button id="btnCreateList"
                class="rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-800">
          Cr√©er la liste
        </button>
      </div>
    </section>

    <!-- List panel -->
    <section id="listPanel" class="hidden mt-6 space-y-4">
      <!-- List meta -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <h2 id="txtListTitle" class="text-xl font-bold truncate"></h2>
              <span id="badgeType" class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs font-medium text-slate-700"></span>
              <span id="badgeAccess" class="hidden inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-1 text-xs font-medium text-amber-800">
                üîí Prot√©g√©e
              </span>
              <span id="badgeAdmin" class="hidden inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-800">
                ‚úèÔ∏è √âdition
              </span>
            </div>

            <p id="txtListHint" class="text-sm text-slate-600 mt-2"></p>

            <!-- Counters -->
            <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2">
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Total</div>
                <div id="kpiTotal" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Attribu√©s</div>
                <div id="kpiAssigned" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Termin√©s</div>
                <div id="kpiDone" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Restants</div>
                <div id="kpiLeft" class="text-lg font-semibold">0</div>
              </div>
            </div>
          </div>

          <div class="flex gap-2">
            <button id="btnShare"
                    class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
              Partager
            </button>
            <button id="btnAddSuggested"
                    class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
              + Suggestions
            </button>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
        <div class="flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
            <div>
              <label class="text-sm font-medium text-slate-700">Recherche</label>
              <input id="inpSearch" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                     placeholder="Ex: chaussettes / passeport / coca‚Ä¶" />
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700">Cat√©gorie</label>
              <select id="selCategory" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">Toutes</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700">Statut</label>
              <select id="selStatus" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">Tous</option>
              </select>
            </div>
          </div>

          <div class="flex gap-2">
            <button id="btnAddItem"
                    class="rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-800">
              + Ajouter
            </button>
            <button id="btnResetFilters"
                    class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50">
              R√©initialiser
            </button>
          </div>
        </div>
      </div>

      <!-- Items list -->
      <div class="space-y-2" id="itemsContainer"></div>

      <!-- Footer hint -->
      <div class="text-xs text-slate-500 text-center">
        Astuce : le pr√©nom est m√©moris√© sur cet appareil pour acc√©l√©rer la r√©servation.
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalWrap" class="hidden fixed inset-0 bg-black/40 p-4 z-50">
    <div class="max-w-xl mx-auto mt-10 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <div>
          <h3 id="modalTitle" class="font-semibold"></h3>
          <p id="modalSubtitle" class="text-sm text-slate-600 mt-0.5"></p>
        </div>
        <button id="btnCloseModal" class="rounded-lg px-2 py-1 hover:bg-slate-100">‚úï</button>
      </div>

      <div class="p-5" id="modalBody"></div>

      <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-end gap-2">
        <button id="btnModalSecondary" class="hidden rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50"></button>
        <button id="btnModalPrimary" class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800"></button>
      </div>
    </div>
  </div>

<script type="module">
  /* ===================== Firebase ===================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdbriBVb8NR-VsZcKHzSeJ8xBwWSMZNps",
    authDomain: "liste-de-noel-8c5e0.firebaseapp.com",
    projectId: "liste-de-noel-8c5e0",
    storageBucket: "liste-de-noel-8c5e0.firebasestorage.app",
    messagingSenderId: "1061968081588",
    appId: "1:1061968081588:web:bb1f3cfdcd340c66de5de1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ===================== Templates ===================== */
  const TEMPLATES = {
    cadeaux: {
      label: "üéÅ Cadeaux",
      hint: "R√©servez un cadeau pour √©viter les doublons. Lien + variante comme sur ta liste No√´l.",
      statuses: [
        { key: "disponible", label: "Disponible" },
        { key: "reserve", label: "R√©serv√©" },
        { key: "offert", label: "Offert" },
      ],
      categories: ["G√©n√©ral", "V√™tements", "Tech", "Sport", "Maison", "Exp√©rience", "Autre"],
      fields: {
        qty: false,
        link: true,
        variant: true,
        price: true,
        notes: true,
        category: true
      },
      cta: { take: "R√©server", done: "Offert" },
      suggested: [
        { title: "Id√©e cadeau (√† compl√©ter)", category: "G√©n√©ral" },
        { title: "Chaussettes / v√™tements", category: "V√™tements" },
        { title: "Gadget utile", category: "Tech" },
        { title: "Livre / exp√©rience", category: "Exp√©rience" },
      ]
    },

    courses: {
      label: "üõí Courses / Achats",
      hint: "Liste d‚Äôachats partag√©e : on se r√©partit qui ach√®te quoi, avec quantit√©s.",
      statuses: [
        { key: "a_acheter", label: "√Ä acheter" },
        { key: "achete", label: "Achet√©" },
      ],
      categories: ["Alimentaire", "Hygi√®ne", "Maison", "Boissons", "Fournitures", "Autre"],
      fields: {
        qty: true,
        link: false,
        variant: false,
        price: false,
        notes: true,
        category: true
      },
      cta: { take: "Je l‚Äôach√®te", done: "Achet√©" },
      suggested: [
        { title: "Eau", category: "Boissons", qty: 1, unit: "pack" },
        { title: "P√¢tes", category: "Alimentaire", qty: 1, unit: "paquet" },
        { title: "Papier toilette", category: "Hygi√®ne", qty: 1, unit: "pack" },
        { title: "Liquide vaisselle", category: "Maison", qty: 1, unit: "flacon" },
      ]
    },

    voyage: {
      label: "üß≥ Voyage (checklist)",
      hint: "Checklist perso : coche ce qui est pr√™t. Id√©al documents / v√™tements / tech.",
      statuses: [
        { key: "a_preparer", label: "√Ä pr√©parer" },
        { key: "pret", label: "Pr√™t" },
      ],
      categories: ["Documents", "Sant√©", "V√™tements", "Toilettes", "Tech", "Divers"],
      fields: {
        qty: true,
        link: false,
        variant: false,
        price: false,
        notes: true,
        category: true
      },
      cta: { take: "Je m‚Äôen occupe", done: "Pr√™t" },
      suggested: [
        { title: "Carte d‚Äôidentit√© / Passeport", category: "Documents", qty: 1, unit: "pc" },
        { title: "Chargeur t√©l√©phone", category: "Tech", qty: 1, unit: "pc" },
        { title: "T-shirts", category: "V√™tements", qty: 5, unit: "pcs" },
        { title: "Trousse de toilette", category: "Toilettes", qty: 1, unit: "pc" },
      ]
    },

    roadtrip: {
      label: "üöó Roadtrip",
      hint: "R√©partition logistique : qui prend quoi + statut ‚Äúdans la voiture‚Äù.",
      statuses: [
        { key: "a_prevoir", label: "√Ä pr√©voir" },
        { key: "attribue", label: "Attribu√©" },
        { key: "dans_voiture", label: "Dans la voiture" },
      ],
      categories: ["Voiture", "Camping", "Cuisine", "S√©curit√©", "Tech", "Divers"],
      fields: {
        qty: true,
        link: false,
        variant: false,
        price: false,
        notes: true,
        category: true
      },
      cta: { take: "Je prends", done: "Dans la voiture" },
      suggested: [
        { title: "Trousse de secours", category: "S√©curit√©", qty: 1, unit: "pc" },
        { title: "Lampe frontale", category: "Camping", qty: 1, unit: "pc" },
        { title: "C√¢bles / chargeurs", category: "Tech", qty: 1, unit: "lot" },
        { title: "Glaci√®re", category: "Cuisine", qty: 1, unit: "pc" },
      ]
    },

    repas: {
      label: "üçΩÔ∏è Repas ‚Äúqui ram√®ne quoi‚Äù",
      hint: "Chacun s‚Äôattribue un item : entr√©e / plat / dessert / boissons, etc.",
      statuses: [
        { key: "a_apporter", label: "√Ä apporter" },
        { key: "confirme", label: "Confirm√©" },
        { key: "apporte", label: "Apport√©" },
      ],
      categories: ["Entr√©es", "Plats", "Desserts", "Boissons", "Pain / Glace / Divers"],
      fields: {
        qty: true,
        link: false,
        variant: false,
        price: false,
        notes: true,
        category: true
      },
      cta: { take: "Je ram√®ne", done: "Apport√©" },
      suggested: [
        { title: "Boissons", category: "Boissons", qty: 2, unit: "bouteilles" },
        { title: "Dessert", category: "Desserts", qty: 1, unit: "pc" },
        { title: "Pain", category: "Pain / Glace / Divers", qty: 2, unit: "baguettes" },
        { title: "Gla√ßons", category: "Pain / Glace / Divers", qty: 1, unit: "sachet" },
      ]
    },
  };

  /* ===================== DOM ===================== */
  const $ = (id) => document.getElementById(id);

  const createPanel = $("createPanel");
  const listPanel = $("listPanel");

  const btnShare = $("btnShare");
  const btnShareTop = $("btnShareTop");
  const btnAdminTop = $("btnAdminTop");
  const btnAddItem = $("btnAddItem");
  const btnAddSuggested = $("btnAddSuggested");
  const btnResetFilters = $("btnResetFilters");

  const txtListTitle = $("txtListTitle");
  const badgeType = $("badgeType");
  const badgeAccess = $("badgeAccess");
  const badgeAdmin = $("badgeAdmin");
  const txtListHint = $("txtListHint");

  const inpSearch = $("inpSearch");
  const selCategory = $("selCategory");
  const selStatus = $("selStatus");
  const itemsContainer = $("itemsContainer");

  const kpiTotal = $("kpiTotal");
  const kpiAssigned = $("kpiAssigned");
  const kpiDone = $("kpiDone");
  const kpiLeft = $("kpiLeft");

  // Modal
  const modalWrap = $("modalWrap");
  const modalTitle = $("modalTitle");
  const modalSubtitle = $("modalSubtitle");
  const modalBody = $("modalBody");
  const btnCloseModal = $("btnCloseModal");
  const btnModalPrimary = $("btnModalPrimary");
  const btnModalSecondary = $("btnModalSecondary");

  /* ===================== Helpers ===================== */
  async function sha256(text) {
    const buf = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function showModal({ title, subtitle, bodyHtml, primaryText, onPrimary, secondaryText, onSecondary }) {
    modalTitle.textContent = title || "";
    modalSubtitle.textContent = subtitle || "";
    modalBody.innerHTML = bodyHtml || "";

    btnModalPrimary.textContent = primaryText || "OK";
    btnModalPrimary.onclick = async () => {
      try { await onPrimary?.(); } finally { /* keep modal close managed by action */ }
    };

    if (secondaryText) {
      btnModalSecondary.classList.remove("hidden");
      btnModalSecondary.textContent = secondaryText;
      btnModalSecondary.onclick = async () => { await onSecondary?.(); };
    } else {
      btnModalSecondary.classList.add("hidden");
      btnModalSecondary.onclick = null;
    }

    modalWrap.classList.remove("hidden");
  }

  function closeModal() { modalWrap.classList.add("hidden"); }
  btnCloseModal.onclick = closeModal;
  modalWrap.addEventListener("click", (e) => { if (e.target === modalWrap) closeModal(); });

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;").replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;").replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function fmtQty(item) {
    const q = item.qty;
    const u = item.unit;
    if (!q && q !== 0) return "";
    if (!u) return `‚Ä¢ ${q}`;
    return `‚Ä¢ ${q} ${u}`;
  }

  function copyToClipboard(text) {
    return navigator.clipboard.writeText(text);
  }

  function getOrAskUserName() {
    let name = localStorage.getItem("liste_user_name") || "";
    if (!name) {
      name = prompt("Ton pr√©nom (pour l‚Äôattribution) :") || "";
      name = name.trim();
      if (name) localStorage.setItem("liste_user_name", name);
    }
    return name;
  }

  function setSelectOptions(selectEl, values, firstLabel) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = firstLabel || "Tous";
    selectEl.appendChild(opt0);
    for (const v of values) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }

  function templateStatusLabels(tpl) {
    return Object.fromEntries(tpl.statuses.map(s => [s.key, s.label]));
  }

  function statusClass(key) {
    // visual badge for status
    if (key.includes("done") || key === "offert" || key === "achete" || key === "pret" || key === "dans_voiture" || key === "apporte") {
      return "border-emerald-200 bg-emerald-50 text-emerald-800";
    }
    if (key.includes("reserve") || key.includes("attribue") || key.includes("confirme")) {
      return "border-amber-200 bg-amber-50 text-amber-800";
    }
    return "border-slate-200 bg-slate-50 text-slate-700";
  }

  /* ===================== State ===================== */
  const url = new URL(location.href);
  const listId = url.searchParams.get("list");
  let currentList = null;        // {title,type,adminHash,accessHash,...}
  let currentTemplate = null;
  let isAdmin = false;
  let items = [];                // local cache
  let unsubItems = null;

  /* ===================== Create list ===================== */
  $("btnCreateList").onclick = async () => {
    const title = $("inpListTitle").value.trim();
    const type = $("selListType").value;
    const adminCode = $("inpAdminCode").value.trim();
    const accessCode = $("inpAccessCode").value.trim();

    if (!title) return alert("Le titre est obligatoire.");
    if (!adminCode) return alert("Le code admin est obligatoire.");

    const adminHash = await sha256(adminCode);
    const accessHash = accessCode ? await sha256(accessCode) : null;

    const ref = await addDoc(collection(db, "lists"), {
      title,
      type,
      adminHash,
      accessHash,
      createdAt: serverTimestamp(),
      version: 1
    });

    // Redirect to list
    location.href = `${location.pathname}?list=${ref.id}`;
  };

  /* ===================== Load list flow ===================== */
  async function loadList() {
    if (!listId) return;

    // Switch UI
    createPanel.classList.add("hidden");
    listPanel.classList.remove("hidden");
    btnShareTop.classList.remove("hidden");
    btnAdminTop.classList.remove("hidden");

    // Fetch list doc
    const ref = doc(db, "lists", listId);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      alert("Liste introuvable.");
      location.href = location.pathname;
      return;
    }

    currentList = { id: listId, ...snap.data() };
    currentTemplate = TEMPLATES[currentList.type] || TEMPLATES.cadeaux;

    // Render meta
    txtListTitle.textContent = currentList.title;
    badgeType.textContent = currentTemplate.label;
    txtListHint.textContent = currentTemplate.hint;

    if (currentList.accessHash) badgeAccess.classList.remove("hidden");

    // Access gate
    if (currentList.accessHash) {
      const code = prompt("Code d‚Äôacc√®s requis :");
      if (!code) { location.href = location.pathname; return; }
      const h = await sha256(code.trim());
      if (h !== currentList.accessHash) {
        alert("Code incorrect.");
        location.href = location.pathname;
        return;
      }
    }

    // Prepare filters
    setSelectOptions(selCategory, currentTemplate.categories, "Toutes");
    setSelectOptions(selStatus, currentTemplate.statuses.map(s => s.key), "Tous");

    // Share buttons
    const share = async () => {
      const link = `${location.origin}${location.pathname}?list=${listId}`;
      await copyToClipboard(`${link}\nID: ${listId}`);
      alert("Lien copi√©.");
    };
    btnShare.onclick = share;
    btnShareTop.onclick = share;

    // Admin enable button
    btnAdminTop.onclick = async () => { await openAdminModal(); };

    // Subscribe items
    if (unsubItems) unsubItems();
    const itemsRef = collection(db, "lists", listId, "items");
    const q = query(itemsRef, orderBy("createdAt", "asc"));
    unsubItems = onSnapshot(q, (qs) => {
      items = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      renderAll();
    });

    // Actions
    btnAddItem.onclick = () => openItemModal({ mode: "create" });
    btnAddSuggested.onclick = () => openSuggestedModal();
    btnResetFilters.onclick = () => {
      inpSearch.value = "";
      selCategory.value = "";
      selStatus.value = "";
      renderItems();
    };

    inpSearch.addEventListener("input", () => renderItems());
    selCategory.addEventListener("change", () => renderItems());
    selStatus.addEventListener("change", () => renderItems());
  }

  /* ===================== Admin ===================== */
  async function openAdminModal() {
    showModal({
      title: "Mode √©dition",
      subtitle: "Saisis le code admin pour activer l‚Äôajout / suppression / √©dition compl√®te.",
      bodyHtml: `
        <label class="text-sm font-medium text-slate-700">Code admin</label>
        <input id="mAdminCode" type="password" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Code admin" />
        <div class="mt-3 text-xs text-slate-500">
          Conseil : active l‚Äô√©dition uniquement sur ton appareil.
        </div>
      `,
      primaryText: "Activer",
      secondaryText: isAdmin ? "D√©sactiver" : null,
      onSecondary: () => {
        isAdmin = false;
        badgeAdmin.classList.add("hidden");
        alert("Mode √©dition d√©sactiv√©.");
        closeModal();
        renderItems();
      },
      onPrimary: async () => {
        const code = (document.getElementById("mAdminCode").value || "").trim();
        if (!code) return alert("Code requis.");
        const h = await sha256(code);
        if (h !== currentList.adminHash) return alert("Code incorrect.");

        isAdmin = true;
        badgeAdmin.classList.remove("hidden");
        closeModal();
        renderItems();
      }
    });
  }

  /* ===================== Modals ===================== */
  function openSuggestedModal() {
    const sug = currentTemplate.suggested || [];
    if (!sug.length) return alert("Aucune suggestion pour ce template.");

    const rows = sug.map((s, i) => {
      const t = escapeHtml(s.title);
      const c = escapeHtml(s.category || "");
      const q = s.qty != null ? `${s.qty} ${escapeHtml(s.unit || "")}` : "";
      return `
        <div class="flex items-center justify-between gap-3 border border-slate-200 rounded-xl p-3">
          <div class="min-w-0">
            <div class="font-medium truncate">${t}</div>
            <div class="text-xs text-slate-500">${c}${q ? " ‚Ä¢ " + escapeHtml(q) : ""}</div>
          </div>
          <button data-i="${i}" class="btnAddSug rounded-lg bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800">
            Ajouter
          </button>
        </div>
      `;
    }).join("");

    showModal({
      title: "Suggestions du template",
      subtitle: "Ajoute des items fr√©quents en 1 clic.",
      bodyHtml: `<div class="space-y-2">${rows}</div>`,
      primaryText: "Fermer",
      onPrimary: () => { closeModal(); }
    });

    // bind
    setTimeout(() => {
      document.querySelectorAll(".btnAddSug").forEach(btn => {
        btn.addEventListener("click", async () => {
          const i = Number(btn.getAttribute("data-i"));
          const s = sug[i];
          await addDoc(collection(db, "lists", listId, "items"), {
            title: s.title,
            category: s.category || currentTemplate.categories[0] || "G√©n√©ral",
            qty: s.qty ?? null,
            unit: s.unit ?? null,
            notes: s.notes ?? "",
            link: s.link ?? "",
            variant: s.variant ?? "",
            price: s.price ?? null,
            status: currentTemplate.statuses[0].key,
            assignedTo: null,
            createdAt: serverTimestamp()
          });
        });
      });
    }, 0);
  }

  function openItemModal({ mode, item }) {
    const tpl = currentTemplate;
    const statusOptions = tpl.statuses.map(s => `<option value="${s.key}">${escapeHtml(s.label)}</option>`).join("");
    const catOptions = tpl.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    const v = item || {};
    const title = escapeHtml(v.title || "");
    const notes = escapeHtml(v.notes || "");
    const category = escapeHtml(v.category || (tpl.categories[0] || "G√©n√©ral"));
    const qty = v.qty ?? "";
    const unit = escapeHtml(v.unit || "");
    const link = escapeHtml(v.link || "");
    const variant = escapeHtml(v.variant || "");
    const price = v.price ?? "";
    const status = v.status || tpl.statuses[0].key;

    const fieldRow = (label, html) => `
      <div>
        <label class="text-sm font-medium text-slate-700">${label}</label>
        ${html}
      </div>
    `;

    const bodyParts = [];

    bodyParts.push(fieldRow("Nom", `
      <input id="mTitle" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Ex: Coca / Passeport / Montre‚Ä¶" value="${title}" />
    `));

    if (tpl.fields.category) {
      bodyParts.push(fieldRow("Cat√©gorie", `
        <select id="mCategory" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
          ${catOptions}
        </select>
      `));
    }

    if (tpl.fields.qty) {
      bodyParts.push(`
        <div class="grid grid-cols-2 gap-3">
          ${fieldRow("Quantit√©", `<input id="mQty" inputmode="decimal" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Ex: 2" value="${qty}" />`)}
          ${fieldRow("Unit√©", `<input id="mUnit" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Ex: bouteilles / pcs / pack" value="${unit}" />`)}
        </div>
      `);
    }

    if (tpl.fields.link) {
      bodyParts.push(fieldRow("Lien", `
        <input id="mLink" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Lien produit" value="${link}" />
      `));
    }

    if (tpl.fields.variant) {
      bodyParts.push(fieldRow("Variante", `
        <input id="mVariant" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Couleur / taille / mod√®le" value="${variant}" />
      `));
    }

    if (tpl.fields.price) {
      bodyParts.push(fieldRow("Prix (optionnel)", `
        <input id="mPrice" inputmode="decimal" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Ex: 49.99" value="${price}" />
      `));
    }

    bodyParts.push(fieldRow("Statut", `
      <select id="mStatus" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
        ${statusOptions}
      </select>
    `));

    if (tpl.fields.notes) {
      bodyParts.push(fieldRow("Notes", `
        <textarea id="mNotes" rows="3" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="D√©tails utiles‚Ä¶">${notes}</textarea>
      `));
    }

    const bodyHtml = `<div class="space-y-3">${bodyParts.join("")}</div>`;

    showModal({
      title: mode === "create" ? "Ajouter un item" : "Modifier l‚Äôitem",
      subtitle: "Les champs s‚Äôadaptent au template de la liste.",
      bodyHtml,
      primaryText: mode === "create" ? "Ajouter" : "Enregistrer",
      secondaryText: mode === "edit" ? "Supprimer" : null,
      onSecondary: async () => {
        if (!isAdmin) return alert("Suppression r√©serv√©e au mode √©dition.");
        if (!confirm("Supprimer cet item ?")) return;
        await deleteDoc(doc(db, "lists", listId, "items", item.id));
        closeModal();
      },
      onPrimary: async () => {
        const t = (document.getElementById("mTitle").value || "").trim();
        if (!t) return alert("Le nom est obligatoire.");

        const payload = {
          title: t,
          category: document.getElementById("mCategory") ? document.getElementById("mCategory").value : null,
          qty: document.getElementById("mQty") ? parseMaybeNumber(document.getElementById("mQty").value) : null,
          unit: document.getElementById("mUnit") ? (document.getElementById("mUnit").value || "").trim() : null,
          link: document.getElementById("mLink") ? (document.getElementById("mLink").value || "").trim() : "",
          variant: document.getElementById("mVariant") ? (document.getElementById("mVariant").value || "").trim() : "",
          price: document.getElementById("mPrice") ? parseMaybeNumber(document.getElementById("mPrice").value) : null,
          notes: document.getElementById("mNotes") ? (document.getElementById("mNotes").value || "").trim() : "",
          status: document.getElementById("mStatus").value || currentTemplate.statuses[0].key,
        };

        if (mode === "create") {
          await addDoc(collection(db, "lists", listId, "items"), {
            ...payload,
            assignedTo: null,
            createdAt: serverTimestamp()
          });
        } else {
          if (!isAdmin) return alert("Modification r√©serv√©e au mode √©dition.");
          await updateDoc(doc(db, "lists", listId, "items", item.id), payload);
        }

        closeModal();
      }
    });

    // set selected values after render
    setTimeout(() => {
      if (document.getElementById("mCategory")) document.getElementById("mCategory").value = category;
      document.getElementById("mStatus").value = status;
    }, 0);
  }

  function parseMaybeNumber(v) {
    const s = (v ?? "").toString().trim().replace(",", ".");
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  /* ===================== Rendering ===================== */
  function renderAll() {
    renderKpis();
    renderItems();
  }

  function renderKpis() {
    const total = items.length;

    const doneKeys = new Set(["offert", "achete", "pret", "dans_voiture", "apporte"]);
    // for templates where "done" is different, we treat last status as done as fallback
    const lastStatusKey = currentTemplate.statuses[currentTemplate.statuses.length - 1]?.key;

    const done = items.filter(it => it.status === lastStatusKey || doneKeys.has(it.status)).length;
    const assigned = items.filter(it => !!it.assignedTo).length;
    const left = Math.max(0, total - done);

    kpiTotal.textContent = total;
    kpiAssigned.textContent = assigned;
    kpiDone.textContent = done;
    kpiLeft.textContent = left;
  }

  function renderItems() {
    const tpl = currentTemplate;
    const statusLabel = templateStatusLabels(tpl);

    const search = inpSearch.value.trim().toLowerCase();
    const cat = selCategory.value;
    const st = selStatus.value;

    const filtered = items.filter(it => {
      const okSearch =
        !search ||
        (it.title || "").toLowerCase().includes(search) ||
        (it.notes || "").toLowerCase().includes(search) ||
        (it.category || "").toLowerCase().includes(search);

      const okCat = !cat || (it.category || "") === cat;
      const okSt = !st || (it.status || "") === st;
      return okSearch && okCat && okSt;
    });

    itemsContainer.innerHTML = "";

    if (!filtered.length) {
      itemsContainer.innerHTML = `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 text-center text-slate-600">
          Aucun item. Ajoute-en un, ou utilise <span class="font-semibold">Suggestions</span>.
        </div>
      `;
      return;
    }

    for (const it of filtered) {
      const title = escapeHtml(it.title);
      const notes = escapeHtml(it.notes || "");
      const category = escapeHtml(it.category || "");
      const statusKey = it.status || tpl.statuses[0].key;
      const statusText = escapeHtml(statusLabel[statusKey] || statusKey);
      const assignedTo = it.assignedTo ? escapeHtml(it.assignedTo) : "";
      const link = (it.link || "").trim();
      const variant = (it.variant || "").trim();
      const price = (it.price != null && it.price !== "") ? String(it.price) : "";
      const qtyStr = tpl.fields.qty ? fmtQty(it) : "";

      const canEdit = isAdmin;
      const isAssigned = !!it.assignedTo;

      // CTA logic
      const primaryCtaLabel = !isAssigned ? tpl.cta.take : "Lib√©rer";
      const secondaryCtaLabel = tpl.cta.done;

      const showDone = isAssigned; // only after someone took it
      const doneKey = tpl.statuses[tpl.statuses.length - 1].key;

      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5";

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="font-semibold text-base truncate">${title}</div>
              ${category ? `<span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-2 py-0.5 text-xs text-slate-600">${category}</span>` : ""}
              ${qtyStr ? `<span class="text-xs text-slate-500">${escapeHtml(qtyStr)}</span>` : ""}
            </div>

            <div class="mt-2 flex items-center gap-2 flex-wrap">
              <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-medium ${statusClass(statusKey)}">
                ${statusText}
              </span>
              ${assignedTo ? `<span class="text-xs text-slate-600">Attribu√© √† <span class="font-semibold">${assignedTo}</span></span>` : `<span class="text-xs text-slate-500">Non attribu√©</span>`}
              ${price ? `<span class="text-xs text-slate-500">‚Ä¢ ${escapeHtml(price)} ‚Ç¨</span>` : ""}
              ${variant ? `<span class="text-xs text-slate-500">‚Ä¢ ${escapeHtml(variant)}</span>` : ""}
            </div>

            ${notes ? `<div class="mt-2 text-sm text-slate-600 whitespace-pre-wrap">${notes}</div>` : ""}

            ${link ? `<a class="mt-3 inline-flex text-sm font-semibold text-slate-900 underline hover:text-slate-700" target="_blank" rel="noopener" href="${escapeHtml(link)}">Ouvrir le lien</a>` : ""}
          </div>

          <div class="flex flex-col gap-2 items-end">
            <button class="btnPrimary rounded-xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800" data-id="${it.id}">
              ${escapeHtml(primaryCtaLabel)}
            </button>

            ${showDone ? `
              <button class="btnDone rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50" data-id="${it.id}">
                ${escapeHtml(secondaryCtaLabel)}
              </button>` : ""}

            ${canEdit ? `
              <button class="btnEdit rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50" data-id="${it.id}">
                Modifier
              </button>` : ""}
          </div>
        </div>
      `;

      itemsContainer.appendChild(card);

      // Bind actions
      card.querySelector(".btnPrimary").addEventListener("click", async () => {
        if (!it.assignedTo) {
          const name = getOrAskUserName();
          if (!name) return;

          // set assigned + update status for some templates
          // For cadeaux: from disponible -> reserve
          const next = statusKey === tpl.statuses[0].key ? tpl.statuses[Math.min(1, tpl.statuses.length - 1)]?.key : statusKey;

          await updateDoc(doc(db, "lists", listId, "items", it.id), {
            assignedTo: name,
            status: next || statusKey
          });
        } else {
          // release
          const name = localStorage.getItem("liste_user_name") || "";
          const ok = (!name || name === it.assignedTo) ? true : confirm("Cet item est attribu√© √† quelqu‚Äôun d‚Äôautre. Le lib√©rer quand m√™me ?");
          if (!ok) return;

          await updateDoc(doc(db, "lists", listId, "items", it.id), {
            assignedTo: null,
            status: tpl.statuses[0].key
          });
        }
      });

      const btnDoneEl = card.querySelector(".btnDone");
      if (btnDoneEl) {
        btnDoneEl.addEventListener("click", async () => {
          // Done -> last status
          await updateDoc(doc(db, "lists", listId, "items", it.id), { status: doneKey });
        });
      }

      const btnEditEl = card.querySelector(".btnEdit");
      if (btnEditEl) {
        btnEditEl.addEventListener("click", () => openItemModal({ mode: "edit", item: it }));
      }
    }
  }

  /* ===================== Boot ===================== */
  await loadList();

  // If not in list mode, hide top buttons
  if (!listId) {
    $("btnShareTop").classList.add("hidden");
    $("btnAdminTop").classList.add("hidden");
  }
</script>
</body>
</html>

