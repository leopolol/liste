<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listes partag√©es</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h1 class="text-2xl font-bold tracking-tight truncate">Listes partag√©es</h1>
          <p class="text-slate-600 mt-1 text-sm">
            Ultra simple : cr√©er ‚Üí partager ‚Üí r√©server / attribuer.
          </p>
        </div>

        <div class="flex gap-2 shrink-0">
          <button id="btnShareTop" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
            Partager
          </button>
          <button id="btnEditToggleTop" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
            Mode √©dition
          </button>
        </div>
      </div>
    </header>

    <!-- Create -->
    <section id="createPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
      <h2 class="text-lg font-semibold">Cr√©er une nouvelle liste</h2>
      <p class="text-sm text-slate-600 mt-1">Choisis un template : champs & statuts adapt√©s.</p>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-medium text-slate-700">Titre</label>
          <input id="inpListTitle" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Ex: No√´l 2025 / Repas samedi / Roadtrip Espagne">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Type</label>
          <select id="selListType" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
            <option value="cadeaux">üéÅ Cadeaux</option>
            <option value="courses">üõí Courses / Achats</option>
            <option value="voyage">üß≥ Voyage (checklist)</option>
            <option value="roadtrip">üöó Roadtrip</option>
            <option value="repas">üçΩÔ∏è Repas ‚Äúqui ram√®ne quoi‚Äù</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Code admin (obligatoire)</label>
          <input id="inpAdminCode" type="password" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Active le mode √©dition">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Code d‚Äôacc√®s (optionnel)</label>
          <input id="inpAccessCode" type="password" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Prot√®ge la liste si besoin">
        </div>

        <div id="createGiftExtras" class="md:col-span-2 hidden">
          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            <input id="chkSurpriseDefault" type="checkbox" class="rounded border-slate-300" checked>
            Activer le mode surprise (Cadeaux) : le nom du r√©servant est cach√© aux invit√©s
          </label>
        </div>
      </div>

      <div class="mt-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="text-xs text-slate-500">
          Les codes sont stock√©s <span class="font-semibold">hach√©s</span> (SHA-256). Le lien contient l‚ÄôID de la liste.
        </div>
        <button id="btnCreateList" class="rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-800">
          Cr√©er la liste
        </button>
      </div>
    </section>

    <!-- List -->
    <section id="listPanel" class="hidden mt-6 space-y-4">
      <!-- Meta -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <h2 id="txtListTitle" class="text-xl font-bold truncate"></h2>
              <span id="badgeType" class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs font-semibold text-slate-700"></span>
              <span id="badgeAccess" class="hidden inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-800">
                üîí Prot√©g√©e
              </span>
              <span id="badgeEdit" class="hidden inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-800">
                ‚úèÔ∏è √âdition
              </span>
              <span id="badgeSurprise" class="hidden inline-flex items-center rounded-full border border-fuchsia-200 bg-fuchsia-50 px-2.5 py-1 text-xs font-semibold text-fuchsia-800">
                üéÅ Surprise
              </span>
            </div>
            <p id="txtListHint" class="text-sm text-slate-600 mt-2"></p>

            <!-- KPIs -->
            <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2">
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Total</div>
                <div id="kpiTotal" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Attribu√©s</div>
                <div id="kpiAssigned" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Termin√©s</div>
                <div id="kpiDone" class="text-lg font-semibold">0</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="text-xs text-slate-500">Restants</div>
                <div id="kpiLeft" class="text-lg font-semibold">0</div>
              </div>
            </div>
          </div>

          <div class="flex gap-2 shrink-0">
            <button id="btnShare" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
              Partager
            </button>
            <button id="btnSuggested" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">
              + Suggestions
            </button>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 space-y-3">
        <div class="flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
            <div>
              <label class="text-sm font-medium text-slate-700">Mon nom (r√©servations)</label>
              <input id="inpMyName" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                     placeholder="Ex: Paul">
              <div class="text-xs text-slate-500 mt-1">Utilis√© pour ‚ÄúR√©serv√© par‚Ä¶‚Äù.</div>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700">Cat√©gorie</label>
              <select id="selCategory" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">Toutes</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700">Statut</label>
              <select id="selStatus" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                <option value="">Tous</option>
              </select>
            </div>
          </div>

          <div class="flex gap-2">
            <button id="btnAddQuick" class="rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-800">
              + Ajouter
            </button>
            <button id="btnEditToggle" class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-slate-50">
              Mode √©dition
            </button>
          </div>
        </div>

        <!-- Quick add -->
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
          <label class="text-sm font-semibold text-slate-700">Ajout rapide</label>
          <div class="mt-2 flex gap-2">
            <input id="inpQuickAdd" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                   placeholder="Tape un item puis Entr√©e (ex: Coca, Passeport, Montre...)">
            <button id="btnQuickAddGo" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50">
              Ajouter
            </button>
          </div>
          <div class="text-xs text-slate-500 mt-2">En mode vision, l‚Äôajout est d√©sactiv√©.</div>
        </div>

        <!-- Search -->
        <div>
          <label class="text-sm font-medium text-slate-700">Recherche</label>
          <input id="inpSearch" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="Rechercher dans le titre / notes / cat√©gorie‚Ä¶">
        </div>
      </div>

      <!-- Items -->
      <div id="itemsContainer" class="space-y-2"></div>

      <div class="text-xs text-slate-500 text-center">
        Mode vision : r√©servation uniquement. Mode √©dition : ajout / modification / suppression.
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalWrap" class="hidden fixed inset-0 bg-black/40 p-4 z-50">
    <div class="max-w-xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden"
         style="margin-top: min(10vh, 64px);">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <div>
          <h3 id="modalTitle" class="font-semibold"></h3>
          <p id="modalSubtitle" class="text-sm text-slate-600 mt-0.5"></p>
        </div>
        <button id="btnCloseModal" class="rounded-lg px-2 py-1 hover:bg-slate-100">‚úï</button>
      </div>

      <!-- IMPORTANT: scrollable body to fix ‚Äúslide‚Äù issues -->
      <div id="modalBody" class="p-5 overflow-y-auto" style="max-height: 70vh;"></div>

      <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-end gap-2">
        <button id="btnModalSecondary" class="hidden rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50"></button>
        <button id="btnModalPrimary" class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800"></button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  /* Firebase (nouveau projet) */
  const firebaseConfig = {
    apiKey: "AIzaSyDdbriBVb8NR-VsZcKHzSeJ8xBwWSMZNps",
    authDomain: "liste-de-noel-8c5e0.firebaseapp.com",
    projectId: "liste-de-noel-8c5e0",
    storageBucket: "liste-de-noel-8c5e0.firebasestorage.app",
    messagingSenderId: "1061968081588",
    appId: "1:1061968081588:web:bb1f3cfdcd340c66de5de1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* Templates */
  const TEMPLATES = {
    cadeaux: {
      label: "üéÅ Cadeaux",
      hint: "Comme ta liste No√´l : lien, variante, image, r√©servation pour √©viter les doublons.",
      statuses: [
        { key: "disponible", label: "Disponible" },
        { key: "reserve", label: "R√©serv√©" },
        { key: "offert", label: "Offert" }
      ],
      categories: ["G√©n√©ral", "V√™tements", "Tech", "Sport", "Maison", "Exp√©rience", "Autre"],
      fields: { category: true, qty: false, unit: false, link: true, image: true, variant: true, price: true, notes: true },
      cta: { take: "R√©server", done: "Offert" },
      suggested: [
        { title: "Id√©e cadeau (√† compl√©ter)", category: "G√©n√©ral" },
        { title: "V√™tement / Accessoire", category: "V√™tements" },
        { title: "Gadget utile", category: "Tech" },
        { title: "Exp√©rience (resto / activit√©)", category: "Exp√©rience" }
      ]
    },
    courses: {
      label: "üõí Courses / Achats",
      hint: "R√©partition des achats : quantit√© + ‚ÄúJe l‚Äôach√®te‚Äù.",
      statuses: [
        { key: "a_acheter", label: "√Ä acheter" },
        { key: "achete", label: "Achet√©" }
      ],
      categories: ["Alimentaire", "Hygi√®ne", "Maison", "Boissons", "Fournitures", "Autre"],
      fields: { category: true, qty: true, unit: true, link: false, image: false, variant: false, price: false, notes: true },
      cta: { take: "Je l‚Äôach√®te", done: "Achet√©" },
      suggested: [
        { title: "Eau", category: "Boissons", qty: 1, unit: "pack" },
        { title: "P√¢tes", category: "Alimentaire", qty: 2, unit: "paquets" },
        { title: "Papier toilette", category: "Hygi√®ne", qty: 1, unit: "pack" }
      ]
    },
    voyage: {
      label: "üß≥ Voyage",
      hint: "Checklist : documents, v√™tements, tech. Coche ‚ÄúPr√™t‚Äù.",
      statuses: [
        { key: "a_preparer", label: "√Ä pr√©parer" },
        { key: "pret", label: "Pr√™t" }
      ],
      categories: ["Documents", "Sant√©", "V√™tements", "Toilettes", "Tech", "Divers"],
      fields: { category: true, qty: true, unit: true, link: false, image: false, variant: false, price: false, notes: true },
      cta: { take: "Je m‚Äôen occupe", done: "Pr√™t" },
      suggested: [
        { title: "Passeport / CNI", category: "Documents", qty: 1, unit: "pc" },
        { title: "Chargeur t√©l√©phone", category: "Tech", qty: 1, unit: "pc" },
        { title: "T-shirts", category: "V√™tements", qty: 5, unit: "pcs" }
      ]
    },
    roadtrip: {
      label: "üöó Roadtrip",
      hint: "Logistique : qui prend quoi + statut final ‚ÄúDans la voiture‚Äù.",
      statuses: [
        { key: "a_prevoir", label: "√Ä pr√©voir" },
        { key: "attribue", label: "Attribu√©" },
        { key: "dans_voiture", label: "Dans la voiture" }
      ],
      categories: ["Voiture", "Camping", "Cuisine", "S√©curit√©", "Tech", "Divers"],
      fields: { category: true, qty: true, unit: true, link: false, image: false, variant: false, price: false, notes: true },
      cta: { take: "Je prends", done: "Dans la voiture" },
      suggested: [
        { title: "Trousse de secours", category: "S√©curit√©", qty: 1, unit: "pc" },
        { title: "Lampe frontale", category: "Camping", qty: 1, unit: "pc" },
        { title: "Glaci√®re", category: "Cuisine", qty: 1, unit: "pc" }
      ]
    },
    repas: {
      label: "üçΩÔ∏è Repas",
      hint: "Chacun s‚Äôattribue un item : ‚ÄúJe ram√®ne‚Äù puis ‚ÄúApport√©‚Äù.",
      statuses: [
        { key: "a_apporter", label: "√Ä apporter" },
        { key: "confirme", label: "Confirm√©" },
        { key: "apporte", label: "Apport√©" }
      ],
      categories: ["Entr√©es", "Plats", "Desserts", "Boissons", "Pain / Glace / Divers"],
      fields: { category: true, qty: true, unit: true, link: false, image: false, variant: false, price: false, notes: true },
      cta: { take: "Je ram√®ne", done: "Apport√©" },
      suggested: [
        { title: "Boissons", category: "Boissons", qty: 2, unit: "bouteilles" },
        { title: "Dessert", category: "Desserts", qty: 1, unit: "pc" },
        { title: "Pain", category: "Pain / Glace / Divers", qty: 2, unit: "baguettes" }
      ]
    }
  };

  /* DOM helpers */
  const $ = (id) => document.getElementById(id);

  /* Modal */
  const modalWrap = $("modalWrap");
  const modalTitle = $("modalTitle");
  const modalSubtitle = $("modalSubtitle");
  const modalBody = $("modalBody");
  const btnCloseModal = $("btnCloseModal");
  const btnModalPrimary = $("btnModalPrimary");
  const btnModalSecondary = $("btnModalSecondary");

  function showModal({ title, subtitle, bodyHtml, primaryText, onPrimary, secondaryText, onSecondary }) {
    modalTitle.textContent = title || "";
    modalSubtitle.textContent = subtitle || "";
    modalBody.innerHTML = bodyHtml || "";

    btnModalPrimary.textContent = primaryText || "OK";
    btnModalPrimary.onclick = async () => { await onPrimary?.(); };

    if (secondaryText) {
      btnModalSecondary.classList.remove("hidden");
      btnModalSecondary.textContent = secondaryText;
      btnModalSecondary.onclick = async () => { await onSecondary?.(); };
    } else {
      btnModalSecondary.classList.add("hidden");
      btnModalSecondary.onclick = null;
    }

    modalWrap.classList.remove("hidden");
  }
  function closeModal() { modalWrap.classList.add("hidden"); }
  btnCloseModal.onclick = closeModal;
  modalWrap.addEventListener("click", (e) => { if (e.target === modalWrap) closeModal(); });

  /* Utils */
  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;").replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;").replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  async function sha256(text) {
    const buf = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
  }
  function setSelectOptions(selectEl, values, firstLabel) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = firstLabel || "Tous";
    selectEl.appendChild(opt0);
    for (const v of values) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }
  function statusClass(key) {
    if (["offert","achete","pret","dans_voiture","apporte"].includes(key)) return "border-emerald-200 bg-emerald-50 text-emerald-800";
    if (["reserve","attribue","confirme"].includes(key)) return "border-amber-200 bg-amber-50 text-amber-800";
    return "border-slate-200 bg-slate-50 text-slate-700";
  }
  function parseMaybeNumber(v) {
    const s = (v ?? "").toString().trim().replace(",", ".");
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  /* Share (reliable) */
  async function shareLink(listId) {
    const link = `${location.origin}${location.pathname}?list=${listId}`;
    const text = `Liste: ${link}`;

    // 1) Web Share API (mobile)
    if (navigator.share) {
      try {
        await navigator.share({ title: "Liste partag√©e", text, url: link });
        return;
      } catch (_) {}
    }

    // 2) Clipboard (requires https in most browsers)
    if (navigator.clipboard && location.protocol === "https:") {
      try {
        await navigator.clipboard.writeText(link);
        alert("Lien copi√©.");
        return;
      } catch (_) {}
    }

    // 3) Fallback manual copy
    prompt("Copie ce lien :", link);
  }

  /* App state */
  const url = new URL(location.href);
  const listId = url.searchParams.get("list");

  let currentList = null;        // {id,title,type,adminHash,accessHash,surprise,...}
  let tpl = null;
  let isAdmin = false;
  let items = [];
  let unsub = null;

  /* Create panel: show surprise checkbox only for gifts */
  const selListType = $("selListType");
  const createGiftExtras = $("createGiftExtras");
  function refreshCreateTypeUI() {
    const v = selListType.value;
    if (v === "cadeaux") createGiftExtras.classList.remove("hidden");
    else createGiftExtras.classList.add("hidden");
  }
  selListType.addEventListener("change", refreshCreateTypeUI);
  refreshCreateTypeUI();

  /* Create list */
  $("btnCreateList").onclick = async () => {
    const title = $("inpListTitle").value.trim();
    const type = $("selListType").value;
    const adminCode = $("inpAdminCode").value.trim();
    const accessCode = $("inpAccessCode").value.trim();

    if (!title) return alert("Le titre est obligatoire.");
    if (!adminCode) return alert("Le code admin est obligatoire.");

    const adminHash = await sha256(adminCode);
    const accessHash = accessCode ? await sha256(accessCode) : null;

    const surprise = (type === "cadeaux") ? $("chkSurpriseDefault").checked : false;

    const ref = await addDoc(collection(db, "lists"), {
      title,
      type,
      adminHash,
      accessHash,
      surprise,         // IMPORTANT: hide reserved names for non-admin on gifts
      createdAt: serverTimestamp(),
      version: 2
    });

    location.href = `${location.pathname}?list=${ref.id}`;
  };

  /* Name selection */
  const NAME_KEY = "liste_user_name";
  function initNameField() {
    const v = localStorage.getItem(NAME_KEY) || "";
    $("inpMyName").value = v;
    $("inpMyName").addEventListener("input", () => {
      localStorage.setItem(NAME_KEY, $("inpMyName").value.trim());
    });
  }

  /* Edit toggle */
  async function toggleEditMode() {
    if (!currentList) return;

    if (isAdmin) {
      isAdmin = false;
      $("badgeEdit").classList.add("hidden");
      $("btnEditToggle").textContent = "Mode √©dition";
      $("btnEditToggleTop").textContent = "Mode √©dition";
      renderAll();
      return;
    }

    showModal({
      title: "Activer le mode √©dition",
      subtitle: "Saisis le code admin. En mode vision, personne ne peut ajouter/supprimer.",
      bodyHtml: `
        <label class="text-sm font-medium text-slate-700">Code admin</label>
        <input id="mAdmin" type="password" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Code admin">
      `,
      primaryText: "Activer",
      secondaryText: "Annuler",
      onSecondary: () => closeModal(),
      onPrimary: async () => {
        const code = (document.getElementById("mAdmin").value || "").trim();
        if (!code) return alert("Code requis.");
        const h = await sha256(code);
        if (h !== currentList.adminHash) return alert("Code incorrect.");

        isAdmin = true;
        $("badgeEdit").classList.remove("hidden");
        $("btnEditToggle").textContent = "Quitter √©dition";
        $("btnEditToggleTop").textContent = "Quitter √©dition";
        closeModal();
        renderAll();
      }
    });
  }

  /* Admin settings (surprise toggle for gifts) */
  async function openAdminSettings() {
    if (!isAdmin) return alert("R√©serv√© au mode √©dition.");

    const checked = !!currentList.surprise;
    showModal({
      title: "R√©glages (admin)",
      subtitle: "Options de la liste.",
      bodyHtml: `
        <div class="space-y-3">
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="font-semibold">Template : ${escapeHtml(TEMPLATES[currentList.type]?.label || currentList.type)}</div>
            <div class="text-xs text-slate-500 mt-1">ID : ${escapeHtml(currentList.id)}</div>
          </div>

          ${currentList.type === "cadeaux" ? `
            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input id="mSurprise" type="checkbox" class="rounded border-slate-300" ${checked ? "checked" : ""}>
              Mode surprise : cacher le nom du r√©servant aux invit√©s
            </label>
            <div class="text-xs text-slate-500">L‚Äôadmin voit toujours les noms.</div>
          ` : `
            <div class="text-sm text-slate-600">Aucun r√©glage sp√©cifique pour ce type.</div>
          `}
        </div>
      `,
      primaryText: "Enregistrer",
      secondaryText: "Fermer",
      onSecondary: () => closeModal(),
      onPrimary: async () => {
        if (currentList.type === "cadeaux") {
          const v = !!document.getElementById("mSurprise")?.checked;
          await updateDoc(doc(db, "lists", currentList.id), { surprise: v });
          currentList.surprise = v;
          closeModal();
          renderMetaBadges();
          renderItems();
        } else {
          closeModal();
        }
      }
    });
  }

  /* Item creation: guided modal */
  function openItemCreateModal(prefill = {}) {
    if (!isAdmin) return alert("Ajout r√©serv√© au mode √©dition.");

    const statusOptions = tpl.statuses.map(s => `<option value="${s.key}">${escapeHtml(s.label)}</option>`).join("");
    const catOptions = tpl.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    const v = prefill || {};
    showModal({
      title: "Ajouter un item",
      subtitle: "Les champs s‚Äôadaptent au template.",
      bodyHtml: `
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium text-slate-700">Nom</label>
            <input id="mTitle" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Ex: Montre / Coca / Passeport" value="${escapeHtml(v.title || "")}">
          </div>

          ${tpl.fields.category ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Cat√©gorie</label>
              <select id="mCategory" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2">
                ${catOptions}
              </select>
            </div>` : ""}

          ${tpl.fields.qty ? `
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-medium text-slate-700">Quantit√©</label>
                <input id="mQty" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Ex: 2" value="${v.qty ?? ""}">
              </div>
              <div>
                <label class="text-sm font-medium text-slate-700">Unit√©</label>
                <input id="mUnit" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Ex: bouteilles / pcs / pack" value="${escapeHtml(v.unit || "")}">
              </div>
            </div>` : ""}

          ${tpl.fields.link ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Lien produit</label>
              <input id="mLink" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="https://..." value="${escapeHtml(v.link || "")}">
            </div>` : ""}

          ${tpl.fields.image ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Image (URL)</label>
              <input id="mImage" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="https://...jpg/png/webp" value="${escapeHtml(v.imageUrl || "")}">
              <div class="text-xs text-slate-500 mt-1">Optionnel. Affiche un aper√ßu sur la carte.</div>
            </div>` : ""}

          ${tpl.fields.variant ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Variante (couleur / taille / mod√®le)</label>
              <input id="mVariant" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Ex: Noir / M / Pro" value="${escapeHtml(v.variant || "")}">
            </div>` : ""}

          ${tpl.fields.price ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Prix (optionnel)</label>
              <input id="mPrice" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Ex: 49.99" value="${v.price ?? ""}">
            </div>` : ""}

          <div>
            <label class="text-sm font-medium text-slate-700">Statut</label>
            <select id="mStatus" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2">
              ${statusOptions}
            </select>
          </div>

          ${tpl.fields.notes ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Notes</label>
              <textarea id="mNotes" rows="3" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="D√©tails utiles‚Ä¶">${escapeHtml(v.notes || "")}</textarea>
            </div>` : ""}
        </div>
      `,
      primaryText: "Ajouter",
      secondaryText: "Annuler",
      onSecondary: () => closeModal(),
      onPrimary: async () => {
        const title = (document.getElementById("mTitle").value || "").trim();
        if (!title) return alert("Nom obligatoire.");

        const payload = {
          title,
          category: document.getElementById("mCategory") ? document.getElementById("mCategory").value : null,
          qty: document.getElementById("mQty") ? parseMaybeNumber(document.getElementById("mQty").value) : null,
          unit: document.getElementById("mUnit") ? (document.getElementById("mUnit").value || "").trim() : null,
          link: document.getElementById("mLink") ? (document.getElementById("mLink").value || "").trim() : "",
          imageUrl: document.getElementById("mImage") ? (document.getElementById("mImage").value || "").trim() : "",
          variant: document.getElementById("mVariant") ? (document.getElementById("mVariant").value || "").trim() : "",
          price: document.getElementById("mPrice") ? parseMaybeNumber(document.getElementById("mPrice").value) : null,
          notes: document.getElementById("mNotes") ? (document.getElementById("mNotes").value || "").trim() : "",
          status: document.getElementById("mStatus").value || tpl.statuses[0].key,
          assignedTo: null,
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "lists", currentList.id, "items"), payload);
        closeModal();
      }
    });

    // set defaults
    setTimeout(() => {
      if (document.getElementById("mCategory")) document.getElementById("mCategory").value = v.category || tpl.categories[0] || "G√©n√©ral";
      document.getElementById("mStatus").value = v.status || tpl.statuses[0].key;
    }, 0);
  }

  /* Suggested modal */
  function openSuggestedModal() {
    if (!isAdmin) return alert("Suggestions r√©serv√©es au mode √©dition.");

    const sug = tpl.suggested || [];
    if (!sug.length) return alert("Aucune suggestion pour ce template.");

    const rows = sug.map((s, i) => `
      <div class="flex items-center justify-between gap-3 border border-slate-200 rounded-xl p-3">
        <div class="min-w-0">
          <div class="font-semibold truncate">${escapeHtml(s.title)}</div>
          <div class="text-xs text-slate-500">
            ${escapeHtml(s.category || "")}
            ${s.qty != null ? ` ‚Ä¢ ${escapeHtml(String(s.qty))} ${escapeHtml(s.unit || "")}` : ""}
          </div>
        </div>
        <button data-i="${i}" class="btnAddSug rounded-xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800">Ajouter</button>
      </div>
    `).join("");

    showModal({
      title: "Suggestions",
      subtitle: "Ajout en 1 clic (admin uniquement).",
      bodyHtml: `<div class="space-y-2">${rows}</div>`,
      primaryText: "Fermer",
      onPrimary: () => closeModal()
    });

    setTimeout(() => {
      document.querySelectorAll(".btnAddSug").forEach(btn => {
        btn.addEventListener("click", async () => {
          const i = Number(btn.getAttribute("data-i"));
          const s = sug[i];
          openItemCreateModal(s);
        });
      });
    }, 0);
  }

  /* Render meta badges */
  function renderMetaBadges() {
    $("badgeSurprise").classList.add("hidden");
    if (currentList?.type === "cadeaux" && currentList?.surprise) $("badgeSurprise").classList.remove("hidden");
  }

  /* Render all */
  function renderAll() {
    renderMetaBadges();
    renderKpis();
    renderItems();
    refreshActionAvailability();
  }

  function refreshActionAvailability() {
    // Guests cannot add/suggest/quick-add
    $("btnSuggested").disabled = !isAdmin;
    $("btnSuggested").classList.toggle("opacity-50", !isAdmin);
    $("btnSuggested").classList.toggle("cursor-not-allowed", !isAdmin);

    $("btnAddQuick").disabled = !isAdmin;
    $("btnAddQuick").classList.toggle("opacity-50", !isAdmin);
    $("btnAddQuick").classList.toggle("cursor-not-allowed", !isAdmin);

    $("btnQuickAddGo").disabled = !isAdmin;
    $("btnQuickAddGo").classList.toggle("opacity-50", !isAdmin);
    $("btnQuickAddGo").classList.toggle("cursor-not-allowed", !isAdmin);

    $("inpQuickAdd").disabled = !isAdmin;
  }

  function renderKpis() {
    const total = items.length;
    const doneKey = tpl.statuses[tpl.statuses.length - 1]?.key;

    const done = items.filter(it => it.status === doneKey).length;
    const assigned = items.filter(it => !!it.assignedTo).length;
    const left = Math.max(0, total - done);

    $("kpiTotal").textContent = total;
    $("kpiAssigned").textContent = assigned;
    $("kpiDone").textContent = done;
    $("kpiLeft").textContent = left;
  }

  function reservationLabel(it) {
    // Gift surprise: hide names for non-admin
    if (currentList?.type === "cadeaux" && currentList?.surprise && !isAdmin) {
      return it.assignedTo ? "R√©serv√©" : "Disponible";
    }
    return it.assignedTo ? `R√©serv√© par ${it.assignedTo}` : "Disponible";
  }

  function renderItems() {
    const search = ($("inpSearch").value || "").trim().toLowerCase();
    const cat = $("selCategory").value;
    const st = $("selStatus").value;

    const statusLabel = Object.fromEntries(tpl.statuses.map(s => [s.key, s.label]));

    const filtered = items.filter(it => {
      const okSearch =
        !search ||
        (it.title || "").toLowerCase().includes(search) ||
        (it.notes || "").toLowerCase().includes(search) ||
        (it.category || "").toLowerCase().includes(search);

      const okCat = !cat || (it.category || "") === cat;
      const okSt = !st || (it.status || "") === st;
      return okSearch && okCat && okSt;
    });

    const wrap = $("itemsContainer");
    wrap.innerHTML = "";

    if (!filtered.length) {
      wrap.innerHTML = `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 text-center text-slate-600">
          Aucun item. ${isAdmin ? "Ajoute-en un ou utilise Suggestions." : "Attends qu‚Äôun admin ajoute des items."}
        </div>
      `;
      return;
    }

    const doneKey = tpl.statuses[tpl.statuses.length - 1].key;
    const midKey = tpl.statuses[Math.min(1, tpl.statuses.length - 1)]?.key || tpl.statuses[0].key;

    for (const it of filtered) {
      const title = escapeHtml(it.title);
      const category = escapeHtml(it.category || "");
      const notes = escapeHtml(it.notes || "");
      const statusKey = it.status || tpl.statuses[0].key;
      const statusText = escapeHtml(statusLabel[statusKey] || statusKey);

      const qty = (tpl.fields.qty && it.qty != null) ? `${escapeHtml(String(it.qty))}${it.unit ? " " + escapeHtml(it.unit) : ""}` : "";
      const variant = (tpl.fields.variant && it.variant) ? escapeHtml(it.variant) : "";
      const price = (tpl.fields.price && it.price != null) ? escapeHtml(String(it.price)) + " ‚Ç¨" : "";

      const link = (tpl.fields.link && it.link) ? it.link : "";
      const img = (tpl.fields.image && it.imageUrl) ? it.imageUrl : "";

      const isAssigned = !!it.assignedTo;

      const ctaTake = !isAssigned ? tpl.cta.take : "Lib√©rer";
      const ctaDone = tpl.cta.done;

      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5";

      card.innerHTML = `
        <div class="flex gap-3">
          ${img ? `
            <div class="shrink-0 w-20 h-20 rounded-xl border border-slate-200 overflow-hidden bg-slate-100">
              <img src="${escapeHtml(img)}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none'">
            </div>
          ` : ""}

          <div class="min-w-0 flex-1">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-bold text-base truncate">${title}</div>
                <div class="mt-1 flex items-center gap-2 flex-wrap">
                  ${category ? `<span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-2 py-0.5 text-xs text-slate-600">${category}</span>` : ""}
                  ${qty ? `<span class="text-xs text-slate-500">‚Ä¢ ${qty}</span>` : ""}
                  ${variant ? `<span class="text-xs text-slate-500">‚Ä¢ ${variant}</span>` : ""}
                  ${price ? `<span class="text-xs text-slate-500">‚Ä¢ ${price}</span>` : ""}
                </div>
              </div>

              <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-semibold ${statusClass(statusKey)}">
                ${statusText}
              </span>
            </div>

            <div class="mt-2 text-xs text-slate-600 font-medium">
              ${escapeHtml(reservationLabel(it))}
            </div>

            ${notes ? `<div class="mt-2 text-sm text-slate-600 whitespace-pre-wrap">${notes}</div>` : ""}

            ${link ? `<a class="mt-3 inline-flex text-sm font-semibold text-slate-900 underline hover:text-slate-700" target="_blank" rel="noopener" href="${escapeHtml(link)}">Ouvrir le lien</a>` : ""}

            <div class="mt-3 flex flex-wrap gap-2">
              <button class="btnTake rounded-xl bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800" data-id="${it.id}">
                ${escapeHtml(ctaTake)}
              </button>

              ${isAssigned ? `
                <button class="btnDone rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50" data-id="${it.id}">
                  ${escapeHtml(ctaDone)}
                </button>
              ` : ""}

              ${isAdmin ? `
                <button class="btnEdit rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50" data-id="${it.id}">
                  Modifier
                </button>
                <button class="btnDel rounded-xl border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm font-semibold hover:bg-red-100" data-id="${it.id}">
                  Supprimer
                </button>
              ` : ""}
            </div>
          </div>
        </div>
      `;

      $("itemsContainer").appendChild(card);

      // take / release
      card.querySelector(".btnTake").addEventListener("click", async () => {
        if (!isAssigned) {
          let name = ($("inpMyName").value || "").trim();
          if (!name) {
            alert("Renseigne ‚ÄúMon nom‚Äù pour r√©server.");
            $("inpMyName").focus();
            return;
          }
          localStorage.setItem(NAME_KEY, name);

          // move status forward when taking (if currently first)
          const nextStatus = (statusKey === tpl.statuses[0].key) ? midKey : statusKey;

          await updateDoc(doc(db, "lists", currentList.id, "items", it.id), {
            assignedTo: name,
            status: nextStatus
          });
        } else {
          // release: if it's not your name, confirm
          const my = (localStorage.getItem(NAME_KEY) || "").trim();
          if (my && it.assignedTo && my !== it.assignedTo) {
            const ok = confirm("Cet item est r√©serv√© par quelqu‚Äôun d‚Äôautre. Le lib√©rer quand m√™me ?");
            if (!ok) return;
          }
          await updateDoc(doc(db, "lists", currentList.id, "items", it.id), {
            assignedTo: null,
            status: tpl.statuses[0].key
          });
        }
      });

      // done
      const btnDone = card.querySelector(".btnDone");
      if (btnDone) {
        btnDone.addEventListener("click", async () => {
          await updateDoc(doc(db, "lists", currentList.id, "items", it.id), { status: doneKey });
        });
      }

      // edit / delete (admin only)
      const btnEdit = card.querySelector(".btnEdit");
      if (btnEdit) {
        btnEdit.addEventListener("click", () => openItemEditModal(it));
      }
      const btnDel = card.querySelector(".btnDel");
      if (btnDel) {
        btnDel.addEventListener("click", async () => {
          if (!confirm("Supprimer cet item ?")) return;
          await deleteDoc(doc(db, "lists", currentList.id, "items", it.id));
        });
      }
    }
  }

  function openItemEditModal(item) {
    if (!isAdmin) return alert("R√©serv√© au mode √©dition.");

    const statusOptions = tpl.statuses.map(s => `<option value="${s.key}">${escapeHtml(s.label)}</option>`).join("");
    const catOptions = tpl.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    showModal({
      title: "Modifier l‚Äôitem",
      subtitle: "Admin uniquement.",
      bodyHtml: `
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium text-slate-700">Nom</label>
            <input id="mTitle" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${escapeHtml(item.title || "")}">
          </div>

          ${tpl.fields.category ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Cat√©gorie</label>
              <select id="mCategory" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2">
                ${catOptions}
              </select>
            </div>` : ""}

          ${tpl.fields.qty ? `
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-medium text-slate-700">Quantit√©</label>
                <input id="mQty" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${item.qty ?? ""}">
              </div>
              <div>
                <label class="text-sm font-medium text-slate-700">Unit√©</label>
                <input id="mUnit" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${escapeHtml(item.unit || "")}">
              </div>
            </div>` : ""}

          ${tpl.fields.link ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Lien produit</label>
              <input id="mLink" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${escapeHtml(item.link || "")}">
            </div>` : ""}

          ${tpl.fields.image ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Image (URL)</label>
              <input id="mImage" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${escapeHtml(item.imageUrl || "")}">
            </div>` : ""}

          ${tpl.fields.variant ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Variante</label>
              <input id="mVariant" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${escapeHtml(item.variant || "")}">
            </div>` : ""}

          ${tpl.fields.price ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Prix</label>
              <input id="mPrice" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2" value="${item.price ?? ""}">
            </div>` : ""}

          <div>
            <label class="text-sm font-medium text-slate-700">Statut</label>
            <select id="mStatus" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2">
              ${statusOptions}
            </select>
          </div>

          ${tpl.fields.notes ? `
            <div>
              <label class="text-sm font-medium text-slate-700">Notes</label>
              <textarea id="mNotes" rows="3" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2">${escapeHtml(item.notes || "")}</textarea>
            </div>` : ""}

          <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-sm font-semibold">R√©servation</div>
            <div class="text-xs text-slate-500 mt-1">Tu peux lib√©rer l‚Äôitem ici si besoin.</div>
            <button id="mClearRes" class="mt-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50">Lib√©rer</button>
          </div>
        </div>
      `,
      primaryText: "Enregistrer",
      secondaryText: "R√©glages admin",
      onSecondary: async () => { await openAdminSettings(); },
      onPrimary: async () => {
        const payload = {
          title: (document.getElementById("mTitle").value || "").trim(),
          category: document.getElementById("mCategory") ? document.getElementById("mCategory").value : null,
          qty: document.getElementById("mQty") ? parseMaybeNumber(document.getElementById("mQty").value) : null,
          unit: document.getElementById("mUnit") ? (document.getElementById("mUnit").value || "").trim() : null,
          link: document.getElementById("mLink") ? (document.getElementById("mLink").value || "").trim() : "",
          imageUrl: document.getElementById("mImage") ? (document.getElementById("mImage").value || "").trim() : "",
          variant: document.getElementById("mVariant") ? (document.getElementById("mVariant").value || "").trim() : "",
          price: document.getElementById("mPrice") ? parseMaybeNumber(document.getElementById("mPrice").value) : null,
          notes: document.getElementById("mNotes") ? (document.getElementById("mNotes").value || "").trim() : "",
          status: document.getElementById("mStatus").value || tpl.statuses[0].key
        };

        if (!payload.title) return alert("Nom obligatoire.");
        await updateDoc(doc(db, "lists", currentList.id, "items", item.id), payload);
        closeModal();
      }
    });

    setTimeout(() => {
      if (document.getElementById("mCategory")) document.getElementById("mCategory").value = item.category || tpl.categories[0] || "";
      document.getElementById("mStatus").value = item.status || tpl.statuses[0].key;

      document.getElementById("mClearRes").addEventListener("click", async () => {
        await updateDoc(doc(db, "lists", currentList.id, "items", item.id), {
          assignedTo: null,
          status: tpl.statuses[0].key
        });
        alert("Item lib√©r√©.");
      });
    }, 0);
  }

  /* Load list */
  async function loadList() {
    if (!listId) {
      $("btnShareTop").classList.add("hidden");
      $("btnEditToggleTop").classList.add("hidden");
      return;
    }

    $("createPanel").classList.add("hidden");
    $("listPanel").classList.remove("hidden");
    $("btnShareTop").classList.remove("hidden");
    $("btnEditToggleTop").classList.remove("hidden");

    const ref = doc(db, "lists", listId);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      alert("Liste introuvable.");
      location.href = location.pathname;
      return;
    }

    currentList = { id: listId, ...snap.data() };
    tpl = TEMPLATES[currentList.type] || TEMPLATES.cadeaux;

    $("txtListTitle").textContent = currentList.title;
    $("badgeType").textContent = tpl.label;
    $("txtListHint").textContent = tpl.hint;

    if (currentList.accessHash) $("badgeAccess").classList.remove("hidden");

    // Access gate
    if (currentList.accessHash) {
      const code = prompt("Code d‚Äôacc√®s requis :");
      if (!code) { location.href = location.pathname; return; }
      const h = await sha256(code.trim());
      if (h !== currentList.accessHash) {
        alert("Code incorrect.");
        location.href = location.pathname;
        return;
      }
    }

    // Filters
    setSelectOptions($("selCategory"), tpl.categories, "Toutes");
    setSelectOptions($("selStatus"), tpl.statuses.map(s => s.key), "Tous");

    // Name field
    initNameField();

    // Share
    const share = () => shareLink(listId);
    $("btnShare").onclick = share;
    $("btnShareTop").onclick = share;

    // Edit toggle buttons
    $("btnEditToggle").onclick = toggleEditMode;
    $("btnEditToggleTop").onclick = toggleEditMode;

    // Suggested (admin-only)
    $("btnSuggested").onclick = openSuggestedModal;

    // Add (admin-only) -> guided modal
    $("btnAddQuick").onclick = () => openItemCreateModal();

    // Quick add
    async function quickAdd() {
      if (!isAdmin) return alert("Ajout r√©serv√© au mode √©dition.");
      const t = ($("inpQuickAdd").value || "").trim();
      if (!t) return;
      $("inpQuickAdd").value = "";
      await addDoc(collection(db, "lists", currentList.id, "items"), {
        title: t,
        category: tpl.categories[0] || "G√©n√©ral",
        qty: null, unit: null,
        link: "", imageUrl: "", variant: "", price: null,
        notes: "",
        status: tpl.statuses[0].key,
        assignedTo: null,
        createdAt: serverTimestamp()
      });
    }
    $("btnQuickAddGo").onclick = quickAdd;
    $("inpQuickAdd").addEventListener("keydown", (e) => {
      if (e.key === "Enter") quickAdd();
    });

    // Search + filter
    $("inpSearch").addEventListener("input", renderItems);
    $("selCategory").addEventListener("change", renderItems);
    $("selStatus").addEventListener("change", renderItems);

    // Watch list doc to reflect surprise changes etc.
    onSnapshot(ref, (s) => {
      if (s.exists()) {
        const next = { id: currentList.id, ...s.data() };
        currentList = next;
        renderMetaBadges();
        renderItems();
      }
    });

    // Subscribe items
    if (unsub) unsub();
    const itemsRef = collection(db, "lists", currentList.id, "items");
    const q = query(itemsRef, orderBy("createdAt", "asc"));
    unsub = onSnapshot(q, (qs) => {
      items = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      renderAll();
    });

    // Initial badges
    renderMetaBadges();
    refreshActionAvailability();
  }

  await loadList();
</script>
</body>
</html>
